{% extends "posts/base.html" %}
{% block title %}{{ post.title }} - 我的博客{% endblock %}
{% block content %}
    <article class="card mb-4">
        <div class="card-body">
            <div class="mb-3">
                {% if post.category %}
                <span class="badge bg-primary">{{ post.category }}</span>
                {% endif %}
                {% if post.tags %}
                {% for tag in post.tags.split(',') %}
                <span class="badge bg-secondary">{{ tag.strip }}</span>
                {% endfor %}
                {% endif %}
            </div>
            <h1 class="card-title">{{ post.title }}</h1>
            <p class="card-text text-muted">
                <small>作者: <a href="{% url 'user-posts' post.author.username %}" class="text-primary">{{ post.author.username }}</a> | 
                发布时间: {{ post.date_posted|date:"Y-m-d H:i" }}</small>
            </p>
            <hr>
            <div class="card-text">
                {{ post.content|linebreaks }}
            </div>
            <hr>
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-primary like-btn" data-post-id="{{ post.pk }}">
                    👍 {{ post.likes }}
                </button>
                {% if user.is_authenticated and user == post.author %}
                <div>
                    <a href="{% url 'post-update' post.pk %}" class="btn btn-secondary me-2">编辑</a>
                    <a href="{% url 'post-delete' post.pk %}" class="btn btn-danger">删除</a>
                </div>
                {% endif %}
            </div>
        </div>
    </article>
    
    <!-- 评论区域 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>评论</h5>
        </div>
        <div class="card-body">
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'add-comment' post.pk %}">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea class="form-control" rows="3" name="content" placeholder="写下你的评论..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">提交评论</button>
            </form>
            {% else %}
            <p>请<a href="{% url 'login' %}">登录</a>后发表评论</p>
            {% endif %}
            
            <hr>
            
            <!-- 评论列表 -->
            <div class="mt-4">
                <h6>评论列表:</h6>
                <!-- 目前评论功能尚未实现，后续可以添加 -->
                <p class="text-muted">暂无评论</p>
            </div>
        </div>
    </div>
    
    <!-- 相关文章推荐 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>相关文章</h5>
        </div>
        <div class="card-body">
            {% if related_posts %}
            <ul class="list-unstyled">
                {% for related_post in related_posts %}
                <li>
                    <a href="{% url 'post-detail' related_post.pk %}">{{ related_post.title }}</a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">暂无相关文章</p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block javascript %}
<script>
    // 点赞功能
    document.addEventListener('DOMContentLoaded', function() {
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                fetch(`/posts/api/like/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        likeBtn.textContent = `👍 ${data.likes}`;
                    }
                })
                .catch(error => console.error('点赞失败:', error));
            });
        }
    });
    
    // 获取CSRF Token的辅助函数
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}