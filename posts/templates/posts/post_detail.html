{% extends "posts/base.html" %}
{% block title %}{{ post.title }} - æˆ‘çš„åšå®¢{% endblock %}
{% block content %}
    <article class="card mb-4">
        <div class="card-body">
            <div class="mb-3">
                {% if post.category %}
                <span class="badge bg-primary">{{ post.category }}</span>
                {% endif %}
                {% if post.tags %}
                {% for tag in post.tags.split(',') %}
                <span class="badge bg-secondary">{{ tag.strip }}</span>
                {% endfor %}
                {% endif %}
            </div>
            <h1 class="card-title">{{ post.title }}</h1>
            <p class="card-text text-muted">
                <small>ä½œè€…: <a href="{% url 'user-posts' post.author.username %}" class="text-primary">{{ post.author.username }}</a> | 
                å‘å¸ƒæ—¶é—´: {{ post.date_posted|date:"Y-m-d H:i" }}</small>
            </p>
            <hr>
            <div class="card-text">
                {{ post.content|linebreaks }}
            </div>
            <hr>
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-primary like-btn" data-post-id="{{ post.pk }}">
                    ğŸ‘ {{ post.likes }}
                </button>
                {% if user.is_authenticated and user == post.author %}
                <div>
                    <a href="{% url 'post-update' post.pk %}" class="btn btn-secondary me-2">ç¼–è¾‘</a>
                    <a href="{% url 'post-delete' post.pk %}" class="btn btn-danger">åˆ é™¤</a>
                </div>
                {% endif %}
            </div>
        </div>
    </article>
    
    <!-- è¯„è®ºåŒºåŸŸ -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>è¯„è®º</h5>
        </div>
        <div class="card-body">
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'add-comment' post.pk %}">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea class="form-control" rows="3" name="content" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">æäº¤è¯„è®º</button>
            </form>
            {% else %}
            <p>è¯·<a href="{% url 'login' %}">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
            {% endif %}
            
            <hr>
            
            <!-- è¯„è®ºåˆ—è¡¨ -->
            <div class="mt-4">
                <h6>è¯„è®ºåˆ—è¡¨:</h6>
                <!-- ç›®å‰è¯„è®ºåŠŸèƒ½å°šæœªå®ç°ï¼Œåç»­å¯ä»¥æ·»åŠ  -->
                <p class="text-muted">æš‚æ— è¯„è®º</p>
            </div>
        </div>
    </div>
    
    <!-- ç›¸å…³æ–‡ç« æ¨è -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>ç›¸å…³æ–‡ç« </h5>
        </div>
        <div class="card-body">
            {% if related_posts %}
            <ul class="list-unstyled">
                {% for related_post in related_posts %}
                <li>
                    <a href="{% url 'post-detail' related_post.pk %}">{{ related_post.title }}</a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">æš‚æ— ç›¸å…³æ–‡ç« </p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block javascript %}
<script>
    // ç‚¹èµåŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                fetch(`/posts/api/like/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        likeBtn.textContent = `ğŸ‘ ${data.likes}`;
                    }
                })
                .catch(error => console.error('ç‚¹èµå¤±è´¥:', error));
            });
        }
    });
    
    // è·å–CSRF Tokençš„è¾…åŠ©å‡½æ•°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}